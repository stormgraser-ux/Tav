# Insights — 2026-02-22

### 18:30 — BG3SE mod structure (confirmed via docs)
The correct BG3SE Lua mod structure is:
```
Mods/TavSync/
├── meta.lsx
└── ScriptExtender/
    ├── Config.json         ← {"ModTable":"TavSync","FeatureFlags":["Lua"]}
    └── Lua/
        ├── BootstrapServer.lua
        └── BootstrapClient.lua
```
NOT `Story/RawFiles/Lua/` (that's the old pre-SE mod structure — wrong).

### 18:35 — Unpackaged mods + modsettings.lsx reset risk
Warning from BG3 modding wiki: "subfolders in Mods folder cause the game to reset modsettings.lsx."
Mitigation: set modsettings.lsx to read-only (chmod 444 or attrib +R).
If unpackaged mod doesn't load, fallback is BG3 Mod Manager (free, supports symlinked unpackaged mods).

### 18:40 — Client→Server net message pattern for hotkeys
F6 = client-side key event (CHANGED FROM F8 — F8 is BG3's "Quickload Last Save" and fires alongside BG3SE's listener, causing simultaneous load + dump).
Party dump = server-side (needs Osi.DB_Players etc).
Correct pattern:
- BootstrapClient.lua: Ext.Events.KeyInput:Subscribe → Ext.Net.PostMessageToServer("channel", "")
- BootstrapServer.lua: Ext.RegisterNetListener("channel", function(...) ... end)
BG3SE KeyInput does NOT suppress default game key behavior — pick a key with no BG3 binding.
Safe unbound keys: F6, F7 (F5=Quicksave, F8=Quickload, F9=?, F10=?, F11=BG3SE console).

### 18:42 — GEAR_SLOTS vs display slot names
The Party tab uses: head, cloak, chest, hands, feet, neck, ring1, ring2, weapon, offhand, ranged, rangedoh
The original party_dump.lua SLOT_MAP output matches these keys exactly. No mismatch.
The Gear Finder uses: helmet, armour, gloves, boots, amulet, ring, weapon, ranged, shield, cloak (display-only).

### 18:43 — Sync server path
Ext.IO.SaveFile("party_sync.json") writes to:
C:\Users\Owner\AppData\Local\Larian Studios\Baldur's Gate 3\Script Extender\party_sync.json
Sync server (sync-server.js) already reads from this path. No changes needed.
The Script Extender directory is created by BG3SE on first write.

### 19:15 — Class detection via StaticData (confirmed API)
entity.Classes.Classes[1].ClassUUID → UUID string
Ext.StaticData.Get(uuid, "ClassDescription").Name → "Bard", "Barbarian", etc.
All 4 party member class UUIDs confirmed working in live console.
NOTE: Classes[1] is the primary class. Multiclass builds have additional entries in Classes.Classes.

### 19:20 — Weapon slots return nil from GetEquippedItem (RESOLVED)
All variants of slot names (MeleeMainHand, Melee Main Hand, MainHand, etc.) return ok=true item=nil.
Root cause: BG3 stores weapons in InventoryContainer, NOT via Osiris equipment API.
Fix: Read `entity.InventoryOwner.Inventories → inv.InventoryContainer.Items` at fixed keys:
  key 3 = MeleeMainHand (weapon), key 4 = MeleeOffHand (offhand),
  key 5 = RangedMainHand (ranged), key 6 = RangedOffHand (rangedoh).
Higher keys (9, 10, 31, 36, etc.) are non-active weapons (other weapon sets, inventory).
Validate with `slotData.Item.Equipable.Slot` to confirm it's a weapon slot.
Also discovered: `entity.Equipment` component doesn't exist on player entities,
`Wielded` component (via GetAllEntitiesWithComponent) works for companions but NOT host player,
`WeaponSet.WeaponSet` only stores active set name ("Melee"/"Ranged"), not weapon items.

### 19:25 — BG3SE mod changes require game restart
Edits to BootstrapServer.lua only take effect after BG3 fully restarts (not just reloading a save).
Fastest test loop: edit Lua → Alt+F4 BG3 → relaunch → load save → test.
The console-paste method (party_dump.lua) is faster for iteration — no restart needed.
